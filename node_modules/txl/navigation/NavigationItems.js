'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _objectWithoutProperties2 = require('babel-runtime/helpers/objectWithoutProperties');

var _objectWithoutProperties3 = _interopRequireDefault(_objectWithoutProperties2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _immutable = require('immutable');

var _Item = require('./records/Item');

var _Item2 = _interopRequireDefault(_Item);

var _Group = require('./records/Group');

var _Group2 = _interopRequireDefault(_Group);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var safeSet = function safeSet(item, field, val) {
  if (item[field] !== val) {
    return item.set(field, val);
  }

  return item;
};

var isActive = function isActive(name) {
  var activeNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  return activeNames.indexOf(name) !== -1;
};
var isExpanded = function isExpanded(name) {
  var expandedNames = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];
  return expandedNames.indexOf(name) !== -1;
};

var NavigationItems = function () {
  function NavigationItems(_ref) {
    var items = _ref.items,
        defaultTemplate = _ref.defaultTemplate,
        activeNames = _ref.activeNames,
        expandedNames = _ref.expandedNames;
    (0, _classCallCheck3.default)(this, NavigationItems);

    this._defaultTemplate = defaultTemplate;

    if (items instanceof _immutable.List) {
      this._items = items;
    } else {
      this._items = this._parse(items, expandedNames, activeNames);
    }
  }

  (0, _createClass3.default)(NavigationItems, [{
    key: '_parse',
    value: function _parse(arr, expandedNames, activeNames) {
      var _this = this;

      var parseItem = function parseItem(item, defaultTemplate) {
        var active = item.active,
            display = item.display,
            name = item.name,
            template = item.template,
            templateProps = (0, _objectWithoutProperties3.default)(item, ['active', 'display', 'name', 'template']);


        return new _Item2.default({
          active: active || isActive(display, activeNames) || isActive(name, activeNames),
          display: display,
          name: name,
          template: template || defaultTemplate,
          templateProps: templateProps
        });
      };

      var parseGroup = function parseGroup(group) {
        var active = group.active,
            display = group.display,
            expanded = group.expanded,
            icon = group.icon,
            items = group.items,
            name = group.name,
            template = group.template,
            templateProps = (0, _objectWithoutProperties3.default)(group, ['active', 'display', 'expanded', 'icon', 'items', 'name', 'template']);


        var temp = template || _this._defaultTemplate;

        return new _Group2.default({
          active: active || isActive(name, activeNames),
          display: display,
          expanded: expanded || isExpanded(name, expandedNames),
          icon: icon,
          items: (0, _immutable.List)((items || []).map(function (i) {
            return parseItem(i, temp);
          })),
          name: name,
          template: temp,
          templateProps: templateProps
        });
      };

      return (0, _immutable.List)(arr.map(parseGroup));
    }
  }, {
    key: 'updateActive',
    value: function updateActive(activeNames) {
      var update = function update(item) {
        return safeSet(item, 'active', isActive(item.name, activeNames));
      };
      var predicate = function predicate(item) {
        return item.active || isActive(item.name, activeNames);
      };
      return this.update({ update: update }, { predicate: predicate, update: update });
    }
  }, {
    key: 'updateExpanded',
    value: function updateExpanded(expandedNames) {
      var update = function update(group) {
        return safeSet(group, 'expanded', true);
      };
      var predicate = function predicate(group) {
        return isExpanded(group.name, expandedNames);
      };

      return this.update({ predicate: predicate, update: update }, null);
    }
  }, {
    key: 'updateGroup',
    value: function updateGroup(predicate, update) {
      return this.update({ predicate: predicate, update: update });
    }
  }, {
    key: 'update',
    value: function update(groupUpdate, itemUpdate) {
      var updated = this._items.map(function (group) {
        if (groupUpdate.predicate && !groupUpdate.predicate(group)) {
          return null;
        }

        if (itemUpdate != null) {
          return groupUpdate.update(group.update(itemUpdate.predicate, itemUpdate.update));
        }

        return groupUpdate.update(group);
      });

      if (updated.filter(function (i) {
        return i;
      }).size) {
        var result = this._items.mergeWith(function (oldVal, newVal) {
          return newVal == null ? oldVal : newVal;
        }, updated);

        return new NavigationItems({
          defaultTemplate: this._defaultTemplate,
          items: result
        });
      }

      return this;
    }
  }, {
    key: 'valueOf',
    value: function valueOf() {
      return this._items;
    }
  }]);
  return NavigationItems;
}();

var _default = NavigationItems;
exports.default = _default;
;

var _temp = function () {
  if (typeof __REACT_HOT_LOADER__ === 'undefined') {
    return;
  }

  __REACT_HOT_LOADER__.register(safeSet, 'safeSet', 'src/navigation/NavigationItems.js');

  __REACT_HOT_LOADER__.register(isActive, 'isActive', 'src/navigation/NavigationItems.js');

  __REACT_HOT_LOADER__.register(isExpanded, 'isExpanded', 'src/navigation/NavigationItems.js');

  __REACT_HOT_LOADER__.register(NavigationItems, 'NavigationItems', 'src/navigation/NavigationItems.js');

  __REACT_HOT_LOADER__.register(_default, 'default', 'src/navigation/NavigationItems.js');
}();

;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9uYXZpZ2F0aW9uL05hdmlnYXRpb25JdGVtcy5qcyJdLCJuYW1lcyI6WyJzYWZlU2V0IiwiaXRlbSIsImZpZWxkIiwidmFsIiwic2V0IiwiaXNBY3RpdmUiLCJuYW1lIiwiYWN0aXZlTmFtZXMiLCJpbmRleE9mIiwiaXNFeHBhbmRlZCIsImV4cGFuZGVkTmFtZXMiLCJOYXZpZ2F0aW9uSXRlbXMiLCJpdGVtcyIsImRlZmF1bHRUZW1wbGF0ZSIsIl9kZWZhdWx0VGVtcGxhdGUiLCJfaXRlbXMiLCJfcGFyc2UiLCJhcnIiLCJwYXJzZUl0ZW0iLCJhY3RpdmUiLCJkaXNwbGF5IiwidGVtcGxhdGUiLCJ0ZW1wbGF0ZVByb3BzIiwicGFyc2VHcm91cCIsImdyb3VwIiwiZXhwYW5kZWQiLCJpY29uIiwidGVtcCIsIm1hcCIsImkiLCJ1cGRhdGUiLCJwcmVkaWNhdGUiLCJncm91cFVwZGF0ZSIsIml0ZW1VcGRhdGUiLCJ1cGRhdGVkIiwiZmlsdGVyIiwic2l6ZSIsInJlc3VsdCIsIm1lcmdlV2l0aCIsIm9sZFZhbCIsIm5ld1ZhbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBRUE7Ozs7QUFDQTs7Ozs7O0FBRUEsSUFBTUEsVUFBVSxTQUFWQSxPQUFVLENBQUNDLElBQUQsRUFBT0MsS0FBUCxFQUFjQyxHQUFkLEVBQXNCO0FBQ3BDLE1BQUlGLEtBQUtDLEtBQUwsTUFBZ0JDLEdBQXBCLEVBQXlCO0FBQ3ZCLFdBQU9GLEtBQUtHLEdBQUwsQ0FBU0YsS0FBVCxFQUFnQkMsR0FBaEIsQ0FBUDtBQUNEOztBQUVELFNBQU9GLElBQVA7QUFDRCxDQU5EOztBQVFBLElBQU1JLFdBQVcsU0FBWEEsUUFBVyxDQUFDQyxJQUFEO0FBQUEsTUFBT0MsV0FBUCx1RUFBcUIsRUFBckI7QUFBQSxTQUE0QkEsWUFBWUMsT0FBWixDQUFvQkYsSUFBcEIsTUFBOEIsQ0FBQyxDQUEzRDtBQUFBLENBQWpCO0FBQ0EsSUFBTUcsYUFBYSxTQUFiQSxV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TUFBOUMsQ0FBbkIsQ0FBUDtBQUNEOztBQUVELGVBQU9FLFlBQVlGLE1BQVosQ0FBbUJOLEtBQW5CLENBQVA7QUFDRCxPQVZlLENBQWhCOztBQVlBLFVBQUlVLFFBQVFDLE1BQVIsQ0FBZTtBQUFBLGVBQUtOLENBQUw7QUFBQSxPQUFmLEVBQXVCTyxJQUEzQixFQUFpQztBQUMvQixZQUFNQyxTQUFTLEtBQUt0QixNQUFMLENBQVl1QixTQUFaLENBQ2IsVUFBQ0MsTUFBRCxFQUFTQyxNQUFUO0FBQUEsaUJBQXFCQSxVQUFVLElBQVYsR0FBaUJELE1BQWpCLEdBQTBCQyxNQUEvQztBQUFBLFNBRGEsRUFFYk4sT0FGYSxDQUFmOztBQUtBLGVBQU8sSUFBSXZCLGVBQUosQ0FBb0I7QUFDekJFLDJCQUFpQixLQUFLQyxnQkFERztBQUV6QkYsaUJBQU95QjtBQUZrQixTQUFwQixDQUFQO0FBSUQ7O0FBRUQsYUFBTyxJQUFQO0FBQ0Q7Ozs4QkFFUztBQUNSLGFBQU8sS0FBS3RCLE1BQVo7QUFDRDs7Ozs7ZUFHWUosZTs7Ozs7Ozs7O2dDQXhIVFgsTzs7Z0NBUUFLLFE7O2dDQUNBSSxVOztnQ0FFQUUsZSIsImZpbGUiOiJOYXZpZ2F0aW9uSXRlbXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMaXN0IH0gZnJvbSAnaW1tdXRhYmxlJztcblxuaW1wb3J0IEl0ZW0gZnJvbSAnLi9yZWNvcmRzL0l0ZW0nO1xuaW1wb3J0IEdyb3VwIGZyb20gJy4vcmVjb3Jkcy9Hcm91cCc7XG5cbmNvbnN0IHNhZmVTZXQgPSAoaXRlbSwgZmllbGQsIHZhbCkgPT4ge1xuICBpZiAoaXRlbVtmaWVsZF0gIT09IHZhbCkge1xuICAgIHJldHVybiBpdGVtLnNldChmaWVsZCwgdmFsKTtcbiAgfVxuXG4gIHJldHVybiBpdGVtO1xufTtcblxuY29uc3QgaXNBY3RpdmUgPSAobmFtZSwgYWN0aXZlTmFtZXMgPSBbXSkgPT4gYWN0aXZlTmFtZXMuaW5kZXhPZihuYW1lKSAhPT0gLTE7XG5jb25zdCBpc0V4cGFuZGVkID0gKG5hbWUsIGV4cGFuZGVkTmFtZXMgPSBbXSkgPT4gZXhwYW5kZWROYW1lcy5pbmRleE9mKG5hbWUpICE9PSAtMTtcblxuY2xhc3MgTmF2aWdhdGlvbkl0ZW1zIHtcbiAgY29uc3RydWN0b3IoeyBpdGVtcywgZGVmYXVsdFRlbXBsYXRlLCBhY3RpdmVOYW1lcywgZXhwYW5kZWROYW1lcyB9KSB7XG4gICAgdGhpcy5fZGVmYXVsdFRlbXBsYXRlID0gZGVmYXVsdFRlbXBsYXRlO1xuXG4gICAgaWYgKGl0ZW1zIGluc3RhbmNlb2YgTGlzdCkge1xuICAgICAgdGhpcy5faXRlbXMgPSBpdGVtcztcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5faXRlbXMgPSB0aGlzLl9wYXJzZShpdGVtcywgZXhwYW5kZWROYW1lcywgYWN0aXZlTmFtZXMpO1xuICAgIH1cbiAgfVxuXG4gIF9wYXJzZShhcnIsIGV4cGFuZGVkTmFtZXMsIGFjdGl2ZU5hbWVzKSB7XG4gICAgY29uc3QgcGFyc2VJdGVtID0gKGl0ZW0sIGRlZmF1bHRUZW1wbGF0ZSkgPT4ge1xuICAgICAgY29uc3Qge1xuICAgICAgICBhY3RpdmUsXG4gICAgICAgIGRpc3BsYXksXG4gICAgICAgIG5hbWUsXG4gICAgICAgIHRlbXBsYXRlLFxuICAgICAgICAuLi50ZW1wbGF0ZVByb3BzXG4gICAgICB9ID0gaXRlbTtcblxuICAgICAgcmV0dXJuIG5ldyBJdGVtKHtcbiAgICAgICAgYWN0aXZlOiBhY3RpdmUgfHwgaXNBY3RpdmUoZGlzcGxheSwgYWN0aXZlTmFtZXMpIHx8IGlzQWN0aXZlKG5hbWUsIGFjdGl2ZU5hbWVzKSxcbiAgICAgICAgZGlzcGxheSxcbiAgICAgICAgbmFtZSxcbiAgICAgICAgdGVtcGxhdGU6IHRlbXBsYXRlIHx8IGRlZmF1bHRUZW1wbGF0ZSxcbiAgICAgICAgdGVtcGxhdGVQcm9wcyxcbiAgICAgIH0pO1xuICAgIH07XG5cbiAgICBjb25zdCBwYXJzZUdyb3VwID0gKGdyb3VwKSA9PiB7XG4gICAgICBjb25zdCB7XG4gICAgICAgIGFjdGl2ZSxcbiAgICAgICAgZGlzcGxheSxcbiAgICAgICAgZXhwYW5kZWQsXG4gICAgICAgIGljb24sXG4gICAgICAgIGl0ZW1zLFxuICAgICAgICBuYW1lLFxuICAgICAgICB0ZW1wbGF0ZSxcbiAgICAgICAgLi4udGVtcGxhdGVQcm9wc1xuICAgICAgfSA9IGdyb3VwO1xuXG4gICAgICBjb25zdCB0ZW1wID0gdGVtcGxhdGUgfHwgdGhpcy5fZGVmYXVsdFRlbXBsYXRlO1xuXG4gICAgICByZXR1cm4gbmV3IEdyb3VwKHtcbiAgICAgICAgYWN0aXZlOiBhY3RpdmUgfHwgaXNBY3RpdmUobmFtZSwgYWN0aXZlTmFtZXMpLFxuICAgICAgICBkaXNwbGF5LFxuICAgICAgICBleHBhbmRlZDogZXhwYW5kZWQgfHwgaXNFeHBhbmRlZChuYW1lLCBleHBhbmRlZE5hbWVzKSxcbiAgICAgICAgaWNvbixcbiAgICAgICAgaXRlbXM6IExpc3QoKGl0ZW1zIHx8IFtdKS5tYXAoaSA9PiBwYXJzZUl0ZW0oaSwgdGVtcCkpKSxcbiAgICAgICAgbmFtZSxcbiAgICAgICAgdGVtcGxhdGU6IHRlbXAsXG4gICAgICAgIHRlbXBsYXRlUHJvcHMsXG4gICAgICB9KTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIExpc3QoYXJyLm1hcChwYXJzZUdyb3VwKSk7XG4gIH1cblxuICB1cGRhdGVBY3RpdmUoYWN0aXZlTmFtZXMpIHtcbiAgICBjb25zdCB1cGRhdGUgPSBpdGVtID0+IHNhZmVTZXQoaXRlbSwgJ2FjdGl2ZScsIGlzQWN0aXZlKGl0ZW0ubmFtZSwgYWN0aXZlTmFtZXMpKTtcbiAgICBjb25zdCBwcmVkaWNhdGUgPSBpdGVtID0+IGl0ZW0uYWN0aXZlIHx8IGlzQWN0aXZlKGl0ZW0ubmFtZSwgYWN0aXZlTmFtZXMpO1xuICAgIHJldHVybiB0aGlzLnVwZGF0ZSh7IHVwZGF0ZSB9LCB7IHByZWRpY2F0ZSwgdXBkYXRlIH0pO1xuICB9XG5cbiAgdXBkYXRlRXhwYW5kZWQoZXhwYW5kZWROYW1lcykge1xuICAgIGNvbnN0IHVwZGF0ZSA9IGdyb3VwID0+IHNhZmVTZXQoZ3JvdXAsICdleHBhbmRlZCcsIHRydWUpO1xuICAgIGNvbnN0IHByZWRpY2F0ZSA9IGdyb3VwID0+IGlzRXhwYW5kZWQoZ3JvdXAubmFtZSwgZXhwYW5kZWROYW1lcyk7XG5cbiAgICByZXR1cm4gdGhpcy51cGRhdGUoeyBwcmVkaWNhdGUsIHVwZGF0ZSB9LCBudWxsKTtcbiAgfVxuXG4gIHVwZGF0ZUdyb3VwKHByZWRpY2F0ZSwgdXBkYXRlKSB7XG4gICAgcmV0dXJuIHRoaXMudXBkYXRlKHsgcHJlZGljYXRlLCB1cGRhdGUgfSk7XG4gIH1cblxuICB1cGRhdGUoZ3JvdXBVcGRhdGUsIGl0ZW1VcGRhdGUpIHtcbiAgICBjb25zdCB1cGRhdGVkID0gdGhpcy5faXRlbXMubWFwKChncm91cCkgPT4ge1xuICAgICAgaWYgKGdyb3VwVXBkYXRlLnByZWRpY2F0ZSAmJiAhZ3JvdXBVcGRhdGUucHJlZGljYXRlKGdyb3VwKSkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgaWYgKGl0ZW1VcGRhdGUgIT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gZ3JvdXBVcGRhdGUudXBkYXRlKGdyb3VwLnVwZGF0ZShpdGVtVXBkYXRlLnByZWRpY2F0ZSwgaXRlbVVwZGF0ZS51cGRhdGUpKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGdyb3VwVXBkYXRlLnVwZGF0ZShncm91cCk7XG4gICAgfSk7XG5cbiAgICBpZiAodXBkYXRlZC5maWx0ZXIoaSA9PiBpKS5zaXplKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9pdGVtcy5tZXJnZVdpdGgoXG4gICAgICAgIChvbGRWYWwsIG5ld1ZhbCkgPT4gKG5ld1ZhbCA9PSBudWxsID8gb2xkVmFsIDogbmV3VmFsKSxcbiAgICAgICAgdXBkYXRlZFxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIG5ldyBOYXZpZ2F0aW9uSXRlbXMoe1xuICAgICAgICBkZWZhdWx0VGVtcGxhdGU6IHRoaXMuX2RlZmF1bHRUZW1wbGF0ZSxcbiAgICAgICAgaXRlbXM6IHJlc3VsdCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgdmFsdWVPZigpIHtcbiAgICByZXR1cm4gdGhpcy5faXRlbXM7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTmF2aWdhdGlvbkl0ZW1zO1xuIl19