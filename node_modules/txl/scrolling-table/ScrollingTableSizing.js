'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _extends2 = require('babel-runtime/helpers/extends');

var _extends3 = _interopRequireDefault(_extends2);

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _throttle2 = require('lodash/throttle');

var _throttle3 = _interopRequireDefault(_throttle2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _ = require('.');

var _forEachChild = require('./utils/forEachChild');

var _forEachChild2 = _interopRequireDefault(_forEachChild);

var _ScrollingTableRow = require('./ScrollingTableRow');

var _ScrollingTableRow2 = _interopRequireDefault(_ScrollingTableRow);

var _constants = require('./constants');

var _ScrollingTable = require('./ScrollingTable.style');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var babelPluginFlowReactPropTypes_proptype_Headers = require('./constants').babelPluginFlowReactPropTypes_proptype_Headers || require('react').PropTypes.any;

var babelPluginFlowReactPropTypes_proptype_OnHeaderUpdate = require('./constants').babelPluginFlowReactPropTypes_proptype_OnHeaderUpdate || require('react').PropTypes.any;

var babelPluginFlowReactPropTypes_proptype_OnResize = require('./constants').babelPluginFlowReactPropTypes_proptype_OnResize || require('react').PropTypes.any;

/**
 * This is a hidden table rendering that updates the size of the columns
 * when a resize event is triggered.
 */
var ScrollingTableSizing = function (_Component) {
  (0, _inherits3.default)(ScrollingTableSizing, _Component);

  function ScrollingTableSizing(props, context) {
    (0, _classCallCheck3.default)(this, ScrollingTableSizing);

    var _this = (0, _possibleConstructorReturn3.default)(this, (ScrollingTableSizing.__proto__ || (0, _getPrototypeOf2.default)(ScrollingTableSizing)).call(this, props, context));

    _this.state = {
      headerHeight: 0,
      ready: false
    };

    _this._ticking = false;
    _this._handleResizing = function () {
      if (!_this._ticking) {
        window.requestAnimationFrame((0, _throttle3.default)(function () {
          _this._handleColumnWidth();
        }, _constants.RESIZE_REFRESH_RATE));
      }
      _this._ticking = true;
    };
    return _this;
  }

  (0, _createClass3.default)(ScrollingTableSizing, [{
    key: 'componentDidMount',
    value: function componentDidMount() {
      this._handleResizing();

      if (this.props.width === 'auto') {
        window.addEventListener('resize', this._handleResizing);
      }
    }
  }, {
    key: 'componentWillUnmount',
    value: function componentWillUnmount() {
      if (this.props.width === 'auto') {
        window.removeEventListener('resize', this._handleResizing);
      }
    }
  }, {
    key: 'componentWillReceiveProps',
    value: function componentWillReceiveProps(nextProps) {
      var _props = this.props,
          width = _props.width,
          height = _props.height;

      if (nextProps.width !== width || nextProps.height !== height) {
        this._handleResizing();
      }
    }
  }, {
    key: 'shouldComponentUpdate',
    value: function shouldComponentUpdate(nextProps, nextState) {
      if (this.props.rows.size === 0 && nextProps.rows.size !== 0) {
        return true;
      }

      if (this.props.height !== nextProps.height) {
        return true;
      }

      if (this.props.width !== nextProps.width) {
        return true;
      }

      if (this.state.headerHeight !== nextState.headerHeight) {
        return true;
      }

      return this.props.headers !== nextProps.headers;
    }
  }, {
    key: '_renderColumns',
    value: function _renderColumns() {
      var _this2 = this;

      return this.props.headers.toArray().map(function (header) {
        var style = (0, _extends3.default)({}, _ScrollingTable.HEADER_CELL_CONTAINER_STYLES);

        style.minWidth = header.minWidth;
        if (header.width != null && _this2.state.ready) {
          style.width = header.width;
        }

        var HeaderTemplate = header.template;

        return _react2.default.createElement(
          'th',
          { style: _ScrollingTable.HEADER_CELL_SIZING_STYLES, key: header.title },
          _react2.default.createElement(
            'div',
            { style: style },
            _react2.default.createElement(HeaderTemplate, header.toJS())
          )
        );
      });
    }
  }, {
    key: '_renderRows',
    value: function _renderRows() {
      var _this3 = this;

      return this.props.rows.valueSeq().take(_constants.ON_RESIZE_ROW_COUNT).toArray().map(function (row, rowNumber) {
        var headers = _this3.props.headers;

        return _react2.default.createElement(_ScrollingTableRow2.default, {
          headers: headers,
          data: row.data,
          rowNumber: rowNumber,
          key: rowNumber
        });
      });
    }
  }, {
    key: '_handleHeaderWidths',
    value: function _handleHeaderWidths(headerElems) {
      if (headerElems == null || this.state.ready) {
        return;
      }

      var widths = [];
      (0, _forEachChild2.default)(headerElems.firstElementChild, function (cell) {
        widths.push(cell.firstElementChild.offsetWidth);
      });

      var updateWidth = function updateWidth(header, i) {
        if (header.minWidth !== widths[i]) {
          if (widths[i] < header.width) {
            return header.set('minWidth', widths[i]);
          }

          return header.set('minWidth', header.width);
        }

        return header;
      };
      var update = function update(headers) {
        return headers.map(updateWidth);
      };
      this.setState({ headerHeight: headerElems.offsetHeight, ready: true });
      this.props.onHeaderUpdate(update);
    }
  }, {
    key: '_handleColumnWidth',
    value: function _handleColumnWidth() {
      var firstRow = this._rows && this._rows.firstElementChild;

      var widths = [];
      (0, _forEachChild2.default)(firstRow, function (cell) {
        widths.push(cell.clientWidth);
      });

      var updateWidth = function updateWidth(header, i) {
        return header.width !== widths[i] ? header.set('width', widths[i]) : header;
      };

      var update = function update(headers) {
        return headers.map(updateWidth);
      };

      if (firstRow != null && firstRow instanceof HTMLElement) {
        var rowHeight = firstRow.offsetHeight;
        var maxRows = Math.ceil(this._container.offsetHeight / rowHeight);
        this.props.onHeaderUpdate(update);
        this.props.onResize(rowHeight, maxRows, this.props.height - this.state.headerHeight);
      }

      this._ticking = false;
    }
  }, {
    key: '_renderBody',
    value: function _renderBody() {
      var _this4 = this;

      if (!this.state.ready) {
        return null;
      }

      return _react2.default.createElement(
        'tbody',
        { ref: function ref(r) {
            _this4._rows = r;
          } },
        this._renderRows()
      );
    }
  }, {
    key: 'render',
    value: function render() {
      var _this5 = this;

      var style = (0, _extends3.default)({}, _ScrollingTable.TABLE_STYLES);

      if (!this.state.ready) {
        style.minWidth = 'auto';
      }

      return _react2.default.createElement(
        'div',
        {
          ref: function ref(c) {
            _this5._container = c;
          },
          style: _ScrollingTable.SIZING_CONTAINER_STYLES
        },
        _react2.default.createElement(
          'div',
          { style: _ScrollingTable.SIZING_STYLES },
          _react2.default.createElement(
            'table',
            { cellPadding: 0, cellSpacing: 0, style: style },
            _react2.default.createElement(
              'thead',
              {
                ref: function ref(e) {
                  _this5._handleHeaderWidths(e);
                }
              },
              _react2.default.createElement(
                'tr',
                { style: _ScrollingTable.SIZING_HEADER_STYLES },
                this._renderColumns()
              )
            ),
            this._renderBody()
          )
        )
      );
    }
  }]);
  return ScrollingTableSizing;
}(_react.Component);

ScrollingTableSizing.propTypes = {
  headers: babelPluginFlowReactPropTypes_proptype_Headers,
  rows: require('react').PropTypes.any.isRequired,
  height: require('react').PropTypes.oneOfType([require('react').PropTypes.number, require('react').PropTypes.string]).isRequired,
  width: require('react').PropTypes.oneOfType([require('react').PropTypes.number, require('react').PropTypes.string]).isRequired,
  onResize: babelPluginFlowReactPropTypes_proptype_OnResize,
  onHeaderUpdate: babelPluginFlowReactPropTypes_proptype_OnHeaderUpdate
};
exports.default = ScrollingTableSizing;
;

var _temp = function () {
  if (typeof __REACT_HOT_LOADER__ === 'undefined') {
    return;
  }

  __REACT_HOT_LOADER__.register(ScrollingTableSizing, 'ScrollingTableSizing', 'src/scrolling-table/ScrollingTableSizing.jsx');
}();

;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JvbGxpbmctdGFibGUvU2Nyb2xsaW5nVGFibGVTaXppbmcuanN4Il0sIm5hbWVzIjpbIlNjcm9sbGluZ1RhYmxlU2l6aW5nIiwicHJvcHMiLCJjb250ZXh0Iiwic3RhdGUiLCJoZWFkZXJIZWlnaHQiLCJyZWFkeSIsIl90aWNraW5nIiwiX2hhbmRsZVJlc2l6aW5nIiwid2luZG93IiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwiX2hhbmRsZUNvbHVtbldpZHRoIiwid2lkdGgiLCJhZGRFdmVudExpc3RlbmVyIiwicmVtb3ZlRXZlbnRMaXN0ZW5lciIsIm5leHRQcm9wcyIsImhlaWdodCIsIm5leHRTdGF0ZSIsInJvd3MiLCJzaXplIiwiaGVhZGVycyIsInRvQXJyYXkiLCJtYXAiLCJoZWFkZXIiLCJzdHlsZSIsIm1pbldpZHRoIiwiSGVhZGVyVGVtcGxhdGUiLCJ0ZW1wbGF0ZSIsInRpdGxlIiwidG9KUyIsInZhbHVlU2VxIiwidGFrZSIsInJvdyIsInJvd051bWJlciIsImRhdGEiLCJoZWFkZXJFbGVtcyIsIndpZHRocyIsImZpcnN0RWxlbWVudENoaWxkIiwiY2VsbCIsInB1c2giLCJvZmZzZXRXaWR0aCIsInVwZGF0ZVdpZHRoIiwiaSIsInNldCIsInVwZGF0ZSIsInNldFN0YXRlIiwib2Zmc2V0SGVpZ2h0Iiwib25IZWFkZXJVcGRhdGUiLCJmaXJzdFJvdyIsIl9yb3dzIiwiY2xpZW50V2lkdGgiLCJIVE1MRWxlbWVudCIsInJvd0hlaWdodCIsIm1heFJvd3MiLCJNYXRoIiwiY2VpbCIsIl9jb250YWluZXIiLCJvblJlc2l6ZSIsInIiLCJfcmVuZGVyUm93cyIsImMiLCJlIiwiX2hhbmRsZUhlYWRlcldpZHRocyIsIl9yZW5kZXJDb2x1bW5zIiwiX3JlbmRlckJvZHkiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUE7Ozs7QUFHQTs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7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Z0M7QUFBQTs7QUFDL0IsVUFBSSxDQUFDLEtBQUtILEtBQUwsQ0FBV0UsS0FBaEIsRUFBdUI7QUFDckIsZUFBTyxJQUFQO0FBQ0Q7O0FBRUQsYUFDRTtBQUFBO0FBQUEsVUFBTyxLQUFLLGFBQUNvRCxDQUFELEVBQW9CO0FBQUUsbUJBQUtULEtBQUwsR0FBYVMsQ0FBYjtBQUFpQixXQUFuRDtBQUNHLGFBQUtDLFdBQUw7QUFESCxPQURGO0FBS0Q7Ozs2QkFFMEI7QUFBQTs7QUFDekIsVUFBTW5DLGdFQUFOOztBQUVBLFVBQUksQ0FBQyxLQUFLcEIsS0FBTCxDQUFXRSxLQUFoQixFQUF1QjtBQUNyQmtCLGNBQU1DLFFBQU4sR0FBaUIsTUFBakI7QUFDRDs7QUFFRCxhQUNFO0FBQUE7QUFBQTtBQUNFLGVBQUssYUFBQ21DLENBQUQsRUFBb0I7QUFBRSxtQkFBS0osVUFBTCxHQUFrQkksQ0FBbEI7QUFBc0IsV0FEbkQ7QUFFRTtBQUZGO0FBSUU7QUFBQTtBQUFBLFlBQUssb0NBQUw7QUFDRTtBQUFBO0FBQUEsY0FBTyxhQUFhLENBQXBCLEVBQXVCLGFBQWEsQ0FBcEMsRUFBdUMsT0FBT3BDLEtBQTlDO0FBQ0U7QUFBQTtBQUFBO0FBQ0UscUJBQUssYUFBQ3FDLENBQUQsRUFBb0I7QUFDdkIseUJBQUtDLG1CQUFMLENBQXlCRCxDQUF6QjtBQUNEO0FBSEg7QUFLRTtBQUFBO0FBQUEsa0JBQUksMkNBQUo7QUFDRyxxQkFBS0UsY0FBTDtBQURIO0FBTEYsYUFERjtBQVVHLGlCQUFLQyxXQUFMO0FBVkg7QUFERjtBQUpGLE9BREY7QUFxQkQ7Ozs7Ozs7Ozs7Ozs7a0JBdE1rQi9ELG9COzs7Ozs7OztnQ0FBQUEsb0IiLCJmaWxlIjoiU2Nyb2xsaW5nVGFibGVTaXppbmcuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgUmVhY3QsIHsgQ29tcG9uZW50IH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IHsgdGhyb3R0bGUgfSBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgeyBIZWFkZXIsIFJvdywgUm93cyB9IGZyb20gJy4nO1xuaW1wb3J0IGZvckVhY2hDaGlsZCBmcm9tICcuL3V0aWxzL2ZvckVhY2hDaGlsZCc7XG5pbXBvcnQgU2Nyb2xsaW5nVGFibGVSb3cgZnJvbSAnLi9TY3JvbGxpbmdUYWJsZVJvdyc7XG5pbXBvcnQgeyBPTl9SRVNJWkVfUk9XX0NPVU5ULCBSRVNJWkVfUkVGUkVTSF9SQVRFIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHtcbiAgSEVBREVSX0NFTExfU0laSU5HX1NUWUxFUyxcbiAgSEVBREVSX0NFTExfQ09OVEFJTkVSX1NUWUxFUyxcbiAgU0laSU5HX1NUWUxFUyxcbiAgVEFCTEVfU1RZTEVTLFxuICBTSVpJTkdfSEVBREVSX1NUWUxFUyxcbiAgU0laSU5HX0NPTlRBSU5FUl9TVFlMRVMsXG59IGZyb20gJy4vU2Nyb2xsaW5nVGFibGUuc3R5bGUnO1xuaW1wb3J0IHR5cGUgeyBPblJlc2l6ZSwgT25IZWFkZXJVcGRhdGUsIEhlYWRlcnMgfSBmcm9tICcuL2NvbnN0YW50cyc7XG5cbnR5cGUgUHJvcHMgPSB7XG4gIGhlYWRlcnM6IEhlYWRlcnMsXG4gIHJvd3M6IFJvd3MsXG4gIGhlaWdodDogbnVtYmVyIHwgc3RyaW5nLFxuICB3aWR0aDogbnVtYmVyIHwgc3RyaW5nLFxuXG4gIC8vIEV2ZW50IGNhbGxiYWNrc1xuICBvblJlc2l6ZTogT25SZXNpemUsXG4gIG9uSGVhZGVyVXBkYXRlOiBPbkhlYWRlclVwZGF0ZSxcbn07XG5cbnR5cGUgU3RhdGUgPSB7XG4gIGhlYWRlckhlaWdodDogbnVtYmVyLFxufTtcblxuLyoqXG4gKiBUaGlzIGlzIGEgaGlkZGVuIHRhYmxlIHJlbmRlcmluZyB0aGF0IHVwZGF0ZXMgdGhlIHNpemUgb2YgdGhlIGNvbHVtbnNcbiAqIHdoZW4gYSByZXNpemUgZXZlbnQgaXMgdHJpZ2dlcmVkLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTY3JvbGxpbmdUYWJsZVNpemluZyBleHRlbmRzIENvbXBvbmVudCB7XG4gIGNvbnN0cnVjdG9yKHByb3BzOiBQcm9wcywgY29udGV4dDogT2JqZWN0KSB7XG4gICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGhlYWRlckhlaWdodDogMCxcbiAgICAgIHJlYWR5OiBmYWxzZSxcbiAgICB9O1xuXG4gICAgdGhpcy5fdGlja2luZyA9IGZhbHNlO1xuICAgIHRoaXMuX2hhbmRsZVJlc2l6aW5nID0gKCkgPT4ge1xuICAgICAgaWYgKCF0aGlzLl90aWNraW5nKSB7XG4gICAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoXG4gICAgICAgICAgdGhyb3R0bGUoKCkgPT4geyB0aGlzLl9oYW5kbGVDb2x1bW5XaWR0aCgpOyB9LCBSRVNJWkVfUkVGUkVTSF9SQVRFKVxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgdGhpcy5fdGlja2luZyA9IHRydWU7XG4gICAgfTtcbiAgfVxuXG4gIHByb3BzOiBQcm9wcztcbiAgc3RhdGU6IFN0YXRlO1xuXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgIHRoaXMuX2hhbmRsZVJlc2l6aW5nKCk7XG5cbiAgICBpZiAodGhpcy5wcm9wcy53aWR0aCA9PT0gJ2F1dG8nKSB7XG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5faGFuZGxlUmVzaXppbmcpO1xuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIGlmICh0aGlzLnByb3BzLndpZHRoID09PSAnYXV0bycpIHtcbiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLl9oYW5kbGVSZXNpemluZyk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHMpIHtcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKG5leHRQcm9wcy53aWR0aCAhPT0gd2lkdGggfHwgbmV4dFByb3BzLmhlaWdodCAhPT0gaGVpZ2h0KSB7XG4gICAgICB0aGlzLl9oYW5kbGVSZXNpemluZygpO1xuICAgIH1cbiAgfVxuXG4gIHNob3VsZENvbXBvbmVudFVwZGF0ZShuZXh0UHJvcHM6IFByb3BzLCBuZXh0U3RhdGU6IFN0YXRlKTogYm9vbGVhbiB7XG4gICAgaWYgKHRoaXMucHJvcHMucm93cy5zaXplID09PSAwICYmIG5leHRQcm9wcy5yb3dzLnNpemUgIT09IDApIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnByb3BzLmhlaWdodCAhPT0gbmV4dFByb3BzLmhlaWdodCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucHJvcHMud2lkdGggIT09IG5leHRQcm9wcy53aWR0aCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc3RhdGUuaGVhZGVySGVpZ2h0ICE9PSBuZXh0U3RhdGUuaGVhZGVySGVpZ2h0KSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5wcm9wcy5oZWFkZXJzICE9PSBuZXh0UHJvcHMuaGVhZGVycztcbiAgfVxuXG4gIF9oYW5kbGVSZXNpemluZzogKCkgPT4gdm9pZDtcbiAgX3RpY2tpbmc6IGJvb2xlYW47XG4gIF9yb3dzOiBIVE1MRWxlbWVudDtcbiAgX2NvbnRhaW5lcjogSFRNTEVsZW1lbnQ7XG5cbiAgX3JlbmRlckNvbHVtbnMoKTogQXJyYXk8UmVhY3QuRWxlbWVudDwqPj4ge1xuICAgIHJldHVybiB0aGlzLnByb3BzLmhlYWRlcnMudG9BcnJheSgpLm1hcCgoaGVhZGVyOiBIZWFkZXIpOiBSZWFjdC5FbGVtZW50PCo+ID0+IHtcbiAgICAgIGNvbnN0IHN0eWxlID0geyAuLi5IRUFERVJfQ0VMTF9DT05UQUlORVJfU1RZTEVTIH07XG5cbiAgICAgIHN0eWxlLm1pbldpZHRoID0gaGVhZGVyLm1pbldpZHRoO1xuICAgICAgaWYgKGhlYWRlci53aWR0aCAhPSBudWxsICYmIHRoaXMuc3RhdGUucmVhZHkpIHtcbiAgICAgICAgc3R5bGUud2lkdGggPSBoZWFkZXIud2lkdGg7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IEhlYWRlclRlbXBsYXRlID0gaGVhZGVyLnRlbXBsYXRlO1xuXG4gICAgICByZXR1cm4gKFxuICAgICAgICA8dGggc3R5bGU9e0hFQURFUl9DRUxMX1NJWklOR19TVFlMRVN9IGtleT17aGVhZGVyLnRpdGxlfT5cbiAgICAgICAgICA8ZGl2IHN0eWxlPXtzdHlsZX0+XG4gICAgICAgICAgICA8SGVhZGVyVGVtcGxhdGUgey4uLmhlYWRlci50b0pTKCl9IC8+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvdGg+XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgX3JlbmRlclJvd3MoKTogQXJyYXk8UmVhY3QuRWxlbWVudDwqPj4ge1xuICAgIHJldHVybiB0aGlzLnByb3BzLnJvd3MudmFsdWVTZXEoKS50YWtlKE9OX1JFU0laRV9ST1dfQ09VTlQpLnRvQXJyYXkoKVxuICAgICAgLm1hcCgocm93OiBSb3csIHJvd051bWJlcjogbnVtYmVyKTogUmVhY3QuRWxlbWVudDwqPiA9PiB7XG4gICAgICAgIGNvbnN0IHsgaGVhZGVycyB9ID0gdGhpcy5wcm9wcztcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICA8U2Nyb2xsaW5nVGFibGVSb3dcbiAgICAgICAgICAgIGhlYWRlcnM9e2hlYWRlcnN9XG4gICAgICAgICAgICBkYXRhPXtyb3cuZGF0YX1cbiAgICAgICAgICAgIHJvd051bWJlcj17cm93TnVtYmVyfVxuICAgICAgICAgICAga2V5PXtyb3dOdW1iZXJ9XG4gICAgICAgICAgLz5cbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgX2hhbmRsZUhlYWRlcldpZHRocyhoZWFkZXJFbGVtczogSFRNTEVsZW1lbnQpIHtcbiAgICBpZiAoaGVhZGVyRWxlbXMgPT0gbnVsbCB8fCB0aGlzLnN0YXRlLnJlYWR5KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3Qgd2lkdGhzID0gW107XG4gICAgZm9yRWFjaENoaWxkKGhlYWRlckVsZW1zLmZpcnN0RWxlbWVudENoaWxkLCAoY2VsbDogSFRNTEVsZW1lbnQpID0+IHtcbiAgICAgIHdpZHRocy5wdXNoKGNlbGwuZmlyc3RFbGVtZW50Q2hpbGQub2Zmc2V0V2lkdGgpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgdXBkYXRlV2lkdGggPSAoaGVhZGVyOiBIZWFkZXIsIGk6IG51bWJlcik6IEhlYWRlciA9PiB7XG4gICAgICBpZiAoaGVhZGVyLm1pbldpZHRoICE9PSB3aWR0aHNbaV0pIHtcbiAgICAgICAgaWYgKHdpZHRoc1tpXSA8IGhlYWRlci53aWR0aCkge1xuICAgICAgICAgIHJldHVybiBoZWFkZXIuc2V0KCdtaW5XaWR0aCcsIHdpZHRoc1tpXSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaGVhZGVyLnNldCgnbWluV2lkdGgnLCBoZWFkZXIud2lkdGgpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gaGVhZGVyO1xuICAgIH07XG4gICAgY29uc3QgdXBkYXRlID0gKGhlYWRlcnM6IEhlYWRlcnMpID0+IGhlYWRlcnMubWFwKHVwZGF0ZVdpZHRoKTtcbiAgICB0aGlzLnNldFN0YXRlKHsgaGVhZGVySGVpZ2h0OiBoZWFkZXJFbGVtcy5vZmZzZXRIZWlnaHQsIHJlYWR5OiB0cnVlIH0pO1xuICAgIHRoaXMucHJvcHMub25IZWFkZXJVcGRhdGUodXBkYXRlKTtcbiAgfVxuXG4gIF9oYW5kbGVDb2x1bW5XaWR0aCgpIHtcbiAgICBjb25zdCBmaXJzdFJvdyA9IHRoaXMuX3Jvd3MgJiYgdGhpcy5fcm93cy5maXJzdEVsZW1lbnRDaGlsZDtcblxuICAgIGNvbnN0IHdpZHRocyA9IFtdO1xuICAgIGZvckVhY2hDaGlsZChmaXJzdFJvdywgKGNlbGw6IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgICB3aWR0aHMucHVzaChjZWxsLmNsaWVudFdpZHRoKTtcbiAgICB9KTtcblxuICAgIGNvbnN0IHVwZGF0ZVdpZHRoID0gKGhlYWRlcjogSGVhZGVyLCBpOiBudW1iZXIpOiBIZWFkZXIgPT5cbiAgICAgIChoZWFkZXIud2lkdGggIT09IHdpZHRoc1tpXSA/IGhlYWRlci5zZXQoJ3dpZHRoJywgd2lkdGhzW2ldKSA6IGhlYWRlcik7XG5cbiAgICBjb25zdCB1cGRhdGUgPSAoaGVhZGVyczogSGVhZGVycykgPT4gaGVhZGVycy5tYXAodXBkYXRlV2lkdGgpO1xuXG4gICAgaWYgKGZpcnN0Um93ICE9IG51bGwgJiYgZmlyc3RSb3cgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgICAgY29uc3Qgcm93SGVpZ2h0ID0gZmlyc3RSb3cub2Zmc2V0SGVpZ2h0O1xuICAgICAgY29uc3QgbWF4Um93cyA9IE1hdGguY2VpbCh0aGlzLl9jb250YWluZXIub2Zmc2V0SGVpZ2h0IC8gcm93SGVpZ2h0KTtcbiAgICAgIHRoaXMucHJvcHMub25IZWFkZXJVcGRhdGUodXBkYXRlKTtcbiAgICAgIHRoaXMucHJvcHMub25SZXNpemUoXG4gICAgICAgIHJvd0hlaWdodCxcbiAgICAgICAgbWF4Um93cyxcbiAgICAgICAgKHRoaXMucHJvcHMuaGVpZ2h0IC0gdGhpcy5zdGF0ZS5oZWFkZXJIZWlnaHQpXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuX3RpY2tpbmcgPSBmYWxzZTtcbiAgfVxuXG4gIF9yZW5kZXJCb2R5KCk6ID9SZWFjdC5FbGVtZW50PCo+IHtcbiAgICBpZiAoIXRoaXMuc3RhdGUucmVhZHkpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiAoXG4gICAgICA8dGJvZHkgcmVmPXsocjogSFRNTEVsZW1lbnQpID0+IHsgdGhpcy5fcm93cyA9IHI7IH19PlxuICAgICAgICB7dGhpcy5fcmVuZGVyUm93cygpfVxuICAgICAgPC90Ym9keT5cbiAgICApO1xuICB9XG5cbiAgcmVuZGVyKCk6IFJlYWN0LkVsZW1lbnQ8Kj4ge1xuICAgIGNvbnN0IHN0eWxlID0geyAuLi5UQUJMRV9TVFlMRVMgfTtcblxuICAgIGlmICghdGhpcy5zdGF0ZS5yZWFkeSkge1xuICAgICAgc3R5bGUubWluV2lkdGggPSAnYXV0byc7XG4gICAgfVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxkaXZcbiAgICAgICAgcmVmPXsoYzogSFRNTEVsZW1lbnQpID0+IHsgdGhpcy5fY29udGFpbmVyID0gYzsgfX1cbiAgICAgICAgc3R5bGU9e1NJWklOR19DT05UQUlORVJfU1RZTEVTfVxuICAgICAgPlxuICAgICAgICA8ZGl2IHN0eWxlPXtTSVpJTkdfU1RZTEVTfT5cbiAgICAgICAgICA8dGFibGUgY2VsbFBhZGRpbmc9ezB9IGNlbGxTcGFjaW5nPXswfSBzdHlsZT17c3R5bGV9PlxuICAgICAgICAgICAgPHRoZWFkXG4gICAgICAgICAgICAgIHJlZj17KGU6IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5faGFuZGxlSGVhZGVyV2lkdGhzKGUpO1xuICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICA8dHIgc3R5bGU9e1NJWklOR19IRUFERVJfU1RZTEVTfT5cbiAgICAgICAgICAgICAgICB7dGhpcy5fcmVuZGVyQ29sdW1ucygpfVxuICAgICAgICAgICAgICA8L3RyPlxuICAgICAgICAgICAgPC90aGVhZD5cbiAgICAgICAgICAgIHt0aGlzLl9yZW5kZXJCb2R5KCl9XG4gICAgICAgICAgPC90YWJsZT5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICApO1xuICB9XG59XG4iXX0=