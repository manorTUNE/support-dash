'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _getPrototypeOf = require('babel-runtime/core-js/object/get-prototype-of');

var _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactAddonsShallowCompare = require('react-addons-shallow-compare');

var _reactAddonsShallowCompare2 = _interopRequireDefault(_reactAddonsShallowCompare);

var _ScrollingTableHeader = require('./ScrollingTableHeader');

var _ScrollingTableHeader2 = _interopRequireDefault(_ScrollingTableHeader);

var _ = require('./');

var _ScrollingTable = require('./ScrollingTable.style');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var babelPluginFlowReactPropTypes_proptype_Headers = require('./').babelPluginFlowReactPropTypes_proptype_Headers || require('react').PropTypes.any;

var ScrollingTableHeaders = function (_Component) {
  (0, _inherits3.default)(ScrollingTableHeaders, _Component);

  function ScrollingTableHeaders(props, context) {
    (0, _classCallCheck3.default)(this, ScrollingTableHeaders);

    var _this = (0, _possibleConstructorReturn3.default)(this, (ScrollingTableHeaders.__proto__ || (0, _getPrototypeOf2.default)(ScrollingTableHeaders)).call(this, props, context));

    _this._onHeaderResize = function () {
      return _this.___onHeaderResize__REACT_HOT_LOADER__.apply(_this, arguments);
    };

    _this._onDragStart = function () {
      return _this.___onDragStart__REACT_HOT_LOADER__.apply(_this, arguments);
    };

    _this._onDragEnd = function () {
      return _this.___onDragEnd__REACT_HOT_LOADER__.apply(_this, arguments);
    };

    _this._onSort = function () {
      return _this.___onSort__REACT_HOT_LOADER__.apply(_this, arguments);
    };

    _this._onDragOver = function () {
      return _this.___onDragOver__REACT_HOT_LOADER__.apply(_this, arguments);
    };

    _this.state = {
      draggingHeader: null,
      lastDrop: null
    };
    return _this;
  }

  (0, _createClass3.default)(ScrollingTableHeaders, [{
    key: 'shouldComponentUpdate',
    value: function shouldComponentUpdate(nextProps, nextState) {
      return (0, _reactAddonsShallowCompare2.default)(this, nextProps, nextState);
    }
  }, {
    key: '___onHeaderResize__REACT_HOT_LOADER__',
    value: function ___onHeaderResize__REACT_HOT_LOADER__() {
      return this.___onHeaderResize__REACT_HOT_LOADER__.apply(this, arguments);
    }
  }, {
    key: '___onHeaderResize__REACT_HOT_LOADER__',
    value: function ___onHeaderResize__REACT_HOT_LOADER__(header, delta) {
      var update = function update(headers) {
        var index = headers.findIndex(function (val) {
          return val.id === header.id;
        });
        var firstHeader = headers.get(index);
        var secondHeader = headers.get(index + 1);

        var firstHeaderWidth = firstHeader.width - delta;
        var secondHeaderWidth = secondHeader.width + delta;

        /**
         * If the headerWidth is less than the minWidth for that column
         * then the headerWidth should be equal to the minWidth
         * and the other header should be equal to its original width + the change
         * in width in the first.
         */
        if (firstHeaderWidth < firstHeader.minWidth) {
          firstHeaderWidth = firstHeader.minWidth;
          secondHeaderWidth = secondHeader.width + (firstHeader.width - firstHeaderWidth);
        } else if (secondHeaderWidth < secondHeader.minWidth) {
          secondHeaderWidth = secondHeader.minWidth;
          firstHeaderWidth = firstHeader.width + (secondHeader.width - secondHeaderWidth);
        }

        return headers.setIn([index, 'width'], firstHeaderWidth).setIn([index + 1, 'width'], secondHeaderWidth);
      };

      this.props.onHeaderUpdate(update);
    }
  }, {
    key: '___onDragStart__REACT_HOT_LOADER__',
    value: function ___onDragStart__REACT_HOT_LOADER__() {
      return this.___onDragStart__REACT_HOT_LOADER__.apply(this, arguments);
    }
  }, {
    key: '___onDragStart__REACT_HOT_LOADER__',
    value: function ___onDragStart__REACT_HOT_LOADER__(header) {
      this.setState({ draggingHeader: header });
    }
  }, {
    key: '___onDragEnd__REACT_HOT_LOADER__',
    value: function ___onDragEnd__REACT_HOT_LOADER__() {
      return this.___onDragEnd__REACT_HOT_LOADER__.apply(this, arguments);
    }
  }, {
    key: '___onDragEnd__REACT_HOT_LOADER__',
    value: function ___onDragEnd__REACT_HOT_LOADER__() {
      this.setState({ draggingHeader: null, lastDrop: null });
    }
  }, {
    key: '___onSort__REACT_HOT_LOADER__',
    value: function ___onSort__REACT_HOT_LOADER__() {
      return this.___onSort__REACT_HOT_LOADER__.apply(this, arguments);
    }
  }, {
    key: '___onSort__REACT_HOT_LOADER__',
    value: function ___onSort__REACT_HOT_LOADER__(header) {
      var update = function update(headers) {
        var index = headers.findIndex(function (val) {
          return val.id === header.id;
        });
        var h = headers.get(index);
        var getDirection = function getDirection(sortDirection) {
          switch (sortDirection) {
            case 'asc':
              return 'none';
            case 'desc':
              return 'asc';
            default:
              return 'desc';
          }
        };

        return headers.setIn([index, 'sortDirection'], getDirection(h.sortDirection));
      };

      this.props.onHeaderUpdate(update);
    }
  }, {
    key: '___onDragOver__REACT_HOT_LOADER__',
    value: function ___onDragOver__REACT_HOT_LOADER__() {
      return this.___onDragOver__REACT_HOT_LOADER__.apply(this, arguments);
    }
  }, {
    key: '___onDragOver__REACT_HOT_LOADER__',
    value: function ___onDragOver__REACT_HOT_LOADER__(dropTarget) {
      var _state = this.state,
          draggingHeader = _state.draggingHeader,
          lastDrop = _state.lastDrop;

      var validTarget = draggingHeader != null && dropTarget != null;
      if (validTarget && draggingHeader.id !== dropTarget.id && (lastDrop == null || lastDrop.id !== dropTarget.id)) {
        var update = function update(headers) {
          var sourceIndex = headers.findIndex(function (val) {
            return val.id === draggingHeader.id;
          });
          var dropIndex = headers.findIndex(function (val) {
            return val.id === dropTarget.id;
          });

          var sourceHeader = headers.get(sourceIndex);
          var dropHeader = headers.get(dropIndex);

          return headers.set(sourceIndex, dropHeader.set('order', sourceHeader.order)).set(dropIndex, sourceHeader.set('order', dropHeader.order));
        };

        this.props.onHeaderUpdate(update);
        this.setState({ lastDrop: dropTarget });
      }
    }
  }, {
    key: '_renderHeaders',
    value: function _renderHeaders() {
      var _this2 = this;

      return this.props.headers.map(function (header, index) {
        return _react2.default.createElement(_ScrollingTableHeader2.default, {
          onResize: function onResize(delta) {
            _this2._onHeaderResize(header, Math.floor(delta));
          },
          header: header,
          headers: _this2.props.headers,
          onSort: _this2._onSort,
          onDragStart: function onDragStart() {
            return _this2._onDragStart(header);
          },
          onDragEnd: _this2._onDragEnd,
          onDragOver: function onDragOver() {
            return _this2._onDragOver(header);
          },
          key: index
        });
      }).toArray();
    }
  }, {
    key: 'render',
    value: function render() {
      return _react2.default.createElement(
        'div',
        { style: _ScrollingTable.HEADER_STYLES },
        this._renderHeaders()
      );
    }
  }]);
  return ScrollingTableHeaders;
}(_react.Component);

ScrollingTableHeaders.propTypes = {
  headers: babelPluginFlowReactPropTypes_proptype_Headers,
  onHeaderUpdate: require('react').PropTypes.func.isRequired
};
exports.default = ScrollingTableHeaders;
;

var _temp = function () {
  if (typeof __REACT_HOT_LOADER__ === 'undefined') {
    return;
  }

  __REACT_HOT_LOADER__.register(ScrollingTableHeaders, 'ScrollingTableHeaders', 'src/scrolling-table/ScrollingTableHeaders.jsx');
}();

;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JvbGxpbmctdGFibGUvU2Nyb2xsaW5nVGFibGVIZWFkZXJzLmpzeCJdLCJuYW1lcyI6WyJTY3JvbGxpbmdUYWJsZUhlYWRlcnMiLCJwcm9wcyIsImNvbnRleHQiLCJfb25IZWFkZXJSZXNpemUiLCJfb25EcmFnU3RhcnQiLCJfb25EcmFnRW5kIiwiX29uU29ydCIsIl9vbkRyYWdPdmVyIiwic3RhdGUiLCJkcmFnZ2luZ0hlYWRlciIsImxhc3REcm9wIiwibmV4dFByb3BzIiwibmV4dFN0YXRlIiwiaGVhZGVyIiwiZGVsdGEiLCJ1cGRhdGUiLCJoZWFkZXJzIiwiaW5kZXgiLCJmaW5kSW5kZXgiLCJ2YWwiLCJpZCIsImZpcnN0SGVhZGVyIiwiZ2V0Iiwic2Vjb25kSGVhZGVyIiwiZmlyc3RIZWFkZXJXaWR0aCIsIndpZHRoIiwic2Vjb25kSGVhZGVyV2lkdGgiLCJtaW5XaWR0aCIsInNldEluIiwib25IZWFkZXJVcGRhdGUiLCJzZXRTdGF0ZSIsImgiLCJnZXREaXJlY3Rpb24iLCJzb3J0RGlyZWN0aW9uIiwiZHJvcFRhcmdldCIsInZhbGlkVGFyZ2V0Iiwic291cmNlSW5kZXgiLCJkcm9wSW5kZXgiLCJzb3VyY2VIZWFkZXIiLCJkcm9wSGVhZGVyIiwic2V0Iiwib3JkZXIiLCJtYXAiLCJNYXRoIiwiZmxvb3IiLCJ0b0FycmF5IiwiX3JlbmRlckhlYWRlcnMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUNBOztBQUNBOzs7Ozs7SUFjcUJBLHFCOzs7QUFJbkIsaUNBQVlDLEtBQVosRUFBMEJDLE9BQTFCLEVBQTJDO0FBQUE7O0FBQUEsb0tBQ25DRCxLQURtQyxFQUM1QkMsT0FENEI7O0FBQUEsVUFhM0NDLGVBYjJDO0FBQUE7QUFBQTs7QUFBQSxVQTRDM0NDLFlBNUMyQztBQUFBO0FBQUE7O0FBQUEsVUFnRDNDQyxVQWhEMkM7QUFBQTtBQUFBOztBQUFBLFVB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QkksS0FBakI7QUFBQSxlQUM1QjtBQUNFLG9CQUFVLGtCQUFDSCxLQUFELEVBQW1CO0FBQUUsbUJBQUtYLGVBQUwsQ0FBcUJVLE1BQXJCLEVBQTZCOEIsS0FBS0MsS0FBTCxDQUFXOUIsS0FBWCxDQUE3QjtBQUFrRCxXQURuRjtBQUVFLGtCQUFRRCxNQUZWO0FBR0UsbUJBQVMsT0FBS1osS0FBTCxDQUFXZSxPQUh0QjtBQUlFLGtCQUFRLE9BQUtWLE9BSmY7QUFLRSx1QkFBYTtBQUFBLG1CQUFNLE9BQUtGLFlBQUwsQ0FBa0JTLE1BQWxCLENBQU47QUFBQSxXQUxmO0FBTUUscUJBQVcsT0FBS1IsVUFObEI7QUFPRSxzQkFBWTtBQUFBLG1CQUFNLE9BQUtFLFdBQUwsQ0FBaUJNLE1BQWpCLENBQU47QUFBQSxXQVBkO0FBUUUsZUFBS0k7QUFSUCxVQUQ0QjtBQUFBLE9BQXZCLEVBV0Y0QixPQVhFLEVBQVA7QUFZRDs7OzZCQUUwQjtBQUN6QixhQUNFO0FBQUE7QUFBQSxVQUFLLG9DQUFMO0FBQ0csYUFBS0MsY0FBTDtBQURILE9BREY7QUFLRDs7Ozs7Ozs7O2tCQTlIa0I5QyxxQjs7Ozs7Ozs7Z0NBQUFBLHFCIiwiZmlsZSI6IlNjcm9sbGluZ1RhYmxlSGVhZGVycy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCBSZWFjdCwgeyBDb21wb25lbnQgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgc2hhbGxvd0NvbXBhcmUgZnJvbSAncmVhY3QtYWRkb25zLXNoYWxsb3ctY29tcGFyZSc7XG5cbmltcG9ydCBUYWJsZUhlYWRlciBmcm9tICcuL1Njcm9sbGluZ1RhYmxlSGVhZGVyJztcbmltcG9ydCB7IEhlYWRlciB9IGZyb20gJy4vJztcbmltcG9ydCB7XG4gIEhFQURFUl9TVFlMRVMsXG59IGZyb20gJy4vU2Nyb2xsaW5nVGFibGUuc3R5bGUnO1xuaW1wb3J0IHR5cGUgeyBIZWFkZXJzIH0gZnJvbSAnLi8nO1xuXG50eXBlIFByb3BzID0ge1xuICBoZWFkZXJzOiBIZWFkZXJzLFxuICBvbkhlYWRlclVwZGF0ZTogKGhlYWRlcnM6IEhlYWRlcnMpID0+IEhlYWRlcnMsXG59O1xuXG50eXBlIFN0YXRlID0ge1xuICBkcmFnZ2luZ0hlYWRlcjogP0hlYWRlcixcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNjcm9sbGluZ1RhYmxlSGVhZGVycyBleHRlbmRzIENvbXBvbmVudCB7XG4gIHByb3BzOiBQcm9wcztcbiAgc3RhdGU6IFN0YXRlO1xuXG4gIGNvbnN0cnVjdG9yKHByb3BzOiBQcm9wcywgY29udGV4dDogT2JqZWN0KSB7XG4gICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGRyYWdnaW5nSGVhZGVyOiBudWxsLFxuICAgICAgbGFzdERyb3A6IG51bGwsXG4gICAgfTtcbiAgfVxuXG4gIHNob3VsZENvbXBvbmVudFVwZGF0ZShuZXh0UHJvcHM6IFByb3BzLCBuZXh0U3RhdGU6IFN0YXRlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHNoYWxsb3dDb21wYXJlKHRoaXMsIG5leHRQcm9wcywgbmV4dFN0YXRlKTtcbiAgfVxuXG4gIF9vbkhlYWRlclJlc2l6ZSA9IChoZWFkZXI6IEhlYWRlciwgZGVsdGE6IG51bWJlcikgPT4ge1xuICAgIGNvbnN0IHVwZGF0ZSA9IChoZWFkZXJzOiBIZWFkZXJzKSA9PiB7XG4gICAgICBjb25zdCBpbmRleCA9IGhlYWRlcnMuZmluZEluZGV4KHZhbCA9PiB2YWwuaWQgPT09IGhlYWRlci5pZCk7XG4gICAgICBjb25zdCBmaXJzdEhlYWRlciA9IGhlYWRlcnMuZ2V0KGluZGV4KTtcbiAgICAgIGNvbnN0IHNlY29uZEhlYWRlciA9IGhlYWRlcnMuZ2V0KGluZGV4ICsgMSk7XG5cbiAgICAgIGxldCBmaXJzdEhlYWRlcldpZHRoID0gZmlyc3RIZWFkZXIud2lkdGggLSBkZWx0YTtcbiAgICAgIGxldCBzZWNvbmRIZWFkZXJXaWR0aCA9IHNlY29uZEhlYWRlci53aWR0aCArIGRlbHRhO1xuXG4gICAgICAvKipcbiAgICAgICAqIElmIHRoZSBoZWFkZXJXaWR0aCBpcyBsZXNzIHRoYW4gdGhlIG1pbldpZHRoIGZvciB0aGF0IGNvbHVtblxuICAgICAgICogdGhlbiB0aGUgaGVhZGVyV2lkdGggc2hvdWxkIGJlIGVxdWFsIHRvIHRoZSBtaW5XaWR0aFxuICAgICAgICogYW5kIHRoZSBvdGhlciBoZWFkZXIgc2hvdWxkIGJlIGVxdWFsIHRvIGl0cyBvcmlnaW5hbCB3aWR0aCArIHRoZSBjaGFuZ2VcbiAgICAgICAqIGluIHdpZHRoIGluIHRoZSBmaXJzdC5cbiAgICAgICAqL1xuICAgICAgaWYgKGZpcnN0SGVhZGVyV2lkdGggPCBmaXJzdEhlYWRlci5taW5XaWR0aCkge1xuICAgICAgICBmaXJzdEhlYWRlcldpZHRoID0gZmlyc3RIZWFkZXIubWluV2lkdGg7XG4gICAgICAgIHNlY29uZEhlYWRlcldpZHRoID0gc2Vjb25kSGVhZGVyLndpZHRoICsgKGZpcnN0SGVhZGVyLndpZHRoIC0gZmlyc3RIZWFkZXJXaWR0aCk7XG4gICAgICB9IGVsc2UgaWYgKHNlY29uZEhlYWRlcldpZHRoIDwgc2Vjb25kSGVhZGVyLm1pbldpZHRoKSB7XG4gICAgICAgIHNlY29uZEhlYWRlcldpZHRoID0gc2Vjb25kSGVhZGVyLm1pbldpZHRoO1xuICAgICAgICBmaXJzdEhlYWRlcldpZHRoID0gZmlyc3RIZWFkZXIud2lkdGggKyAoc2Vjb25kSGVhZGVyLndpZHRoIC0gc2Vjb25kSGVhZGVyV2lkdGgpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gaGVhZGVyc1xuICAgICAgICAuc2V0SW4oW2luZGV4LCAnd2lkdGgnXSwgZmlyc3RIZWFkZXJXaWR0aClcbiAgICAgICAgLnNldEluKFtpbmRleCArIDEsICd3aWR0aCddLCBzZWNvbmRIZWFkZXJXaWR0aCk7XG4gICAgfTtcblxuICAgIHRoaXMucHJvcHMub25IZWFkZXJVcGRhdGUodXBkYXRlKTtcbiAgfTtcblxuICBfb25EcmFnU3RhcnQgPSAoaGVhZGVyOiBIZWFkZXIpID0+IHtcbiAgICB0aGlzLnNldFN0YXRlKHsgZHJhZ2dpbmdIZWFkZXI6IGhlYWRlciB9KTtcbiAgfTtcblxuICBfb25EcmFnRW5kID0gKCkgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoeyBkcmFnZ2luZ0hlYWRlcjogbnVsbCwgbGFzdERyb3A6IG51bGwgfSk7XG4gIH07XG5cbiAgX29uU29ydCA9IChoZWFkZXI6IEhlYWRlcikgPT4ge1xuICAgIGNvbnN0IHVwZGF0ZSA9IChoZWFkZXJzOiBIZWFkZXJzKSA9PiB7XG4gICAgICBjb25zdCBpbmRleCA9IGhlYWRlcnMuZmluZEluZGV4KHZhbCA9PiB2YWwuaWQgPT09IGhlYWRlci5pZCk7XG4gICAgICBjb25zdCBoID0gaGVhZGVycy5nZXQoaW5kZXgpO1xuICAgICAgY29uc3QgZ2V0RGlyZWN0aW9uID0gKHNvcnREaXJlY3Rpb24pID0+IHtcbiAgICAgICAgc3dpdGNoIChzb3J0RGlyZWN0aW9uKSB7XG4gICAgICAgICAgY2FzZSAnYXNjJzpcbiAgICAgICAgICAgIHJldHVybiAnbm9uZSc7XG4gICAgICAgICAgY2FzZSAnZGVzYyc6XG4gICAgICAgICAgICByZXR1cm4gJ2FzYyc7XG4gICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgIHJldHVybiAnZGVzYyc7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIHJldHVybiBoZWFkZXJzXG4gICAgICAgIC5zZXRJbihbaW5kZXgsICdzb3J0RGlyZWN0aW9uJ10sIGdldERpcmVjdGlvbihoLnNvcnREaXJlY3Rpb24pKTtcbiAgICB9O1xuXG4gICAgdGhpcy5wcm9wcy5vbkhlYWRlclVwZGF0ZSh1cGRhdGUpO1xuICB9O1xuXG4gIF9vbkRyYWdPdmVyID0gKGRyb3BUYXJnZXQ6IEhlYWRlcikgPT4ge1xuICAgIGNvbnN0IHsgZHJhZ2dpbmdIZWFkZXIsIGxhc3REcm9wIH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IHZhbGlkVGFyZ2V0ID0gZHJhZ2dpbmdIZWFkZXIgIT0gbnVsbCAmJiBkcm9wVGFyZ2V0ICE9IG51bGw7XG4gICAgaWYgKHZhbGlkVGFyZ2V0XG4gICAgICAmJiBkcmFnZ2luZ0hlYWRlci5pZCAhPT0gZHJvcFRhcmdldC5pZFxuICAgICAgJiYgKGxhc3REcm9wID09IG51bGwgfHwgbGFzdERyb3AuaWQgIT09IGRyb3BUYXJnZXQuaWQpKSB7XG4gICAgICBjb25zdCB1cGRhdGUgPSAoaGVhZGVyczogSGVhZGVycykgPT4ge1xuICAgICAgICBjb25zdCBzb3VyY2VJbmRleCA9IGhlYWRlcnMuZmluZEluZGV4KFxuICAgICAgICAgICh2YWw6IEhlYWRlcik6IGJvb2xlYW4gPT4gdmFsLmlkID09PSBkcmFnZ2luZ0hlYWRlci5pZFxuICAgICAgICApO1xuICAgICAgICBjb25zdCBkcm9wSW5kZXggPSBoZWFkZXJzLmZpbmRJbmRleChcbiAgICAgICAgICAodmFsOiBIZWFkZXIpOiBib29sZWFuID0+IHZhbC5pZCA9PT0gZHJvcFRhcmdldC5pZFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IHNvdXJjZUhlYWRlciA9IGhlYWRlcnMuZ2V0KHNvdXJjZUluZGV4KTtcbiAgICAgICAgY29uc3QgZHJvcEhlYWRlciA9IGhlYWRlcnMuZ2V0KGRyb3BJbmRleCk7XG5cbiAgICAgICAgcmV0dXJuIGhlYWRlcnNcbiAgICAgICAgICAuc2V0KHNvdXJjZUluZGV4LCBkcm9wSGVhZGVyLnNldCgnb3JkZXInLCBzb3VyY2VIZWFkZXIub3JkZXIpKVxuICAgICAgICAgIC5zZXQoZHJvcEluZGV4LCBzb3VyY2VIZWFkZXIuc2V0KCdvcmRlcicsIGRyb3BIZWFkZXIub3JkZXIpKTtcbiAgICAgIH07XG5cbiAgICAgIHRoaXMucHJvcHMub25IZWFkZXJVcGRhdGUodXBkYXRlKTtcbiAgICAgIHRoaXMuc2V0U3RhdGUoeyBsYXN0RHJvcDogZHJvcFRhcmdldCB9KTtcbiAgICB9XG4gIH07XG5cbiAgX3JlbmRlckhlYWRlcnMoKTogQXJyYXk8UmVhY3QuRWxlbWVudDwqPj4ge1xuICAgIHJldHVybiB0aGlzLnByb3BzLmhlYWRlcnMubWFwKChoZWFkZXI6IEhlYWRlciwgaW5kZXg6IG51bWJlcik6IFJlYWN0LkVsZW1lbnQ8Kj4gPT4gKFxuICAgICAgPFRhYmxlSGVhZGVyXG4gICAgICAgIG9uUmVzaXplPXsoZGVsdGE6IG51bWJlcikgPT4geyB0aGlzLl9vbkhlYWRlclJlc2l6ZShoZWFkZXIsIE1hdGguZmxvb3IoZGVsdGEpKTsgfX1cbiAgICAgICAgaGVhZGVyPXtoZWFkZXJ9XG4gICAgICAgIGhlYWRlcnM9e3RoaXMucHJvcHMuaGVhZGVyc31cbiAgICAgICAgb25Tb3J0PXt0aGlzLl9vblNvcnR9XG4gICAgICAgIG9uRHJhZ1N0YXJ0PXsoKSA9PiB0aGlzLl9vbkRyYWdTdGFydChoZWFkZXIpfVxuICAgICAgICBvbkRyYWdFbmQ9e3RoaXMuX29uRHJhZ0VuZH1cbiAgICAgICAgb25EcmFnT3Zlcj17KCkgPT4gdGhpcy5fb25EcmFnT3ZlcihoZWFkZXIpfVxuICAgICAgICBrZXk9e2luZGV4fVxuICAgICAgLz5cbiAgICAgICkpLnRvQXJyYXkoKTtcbiAgfVxuXG4gIHJlbmRlcigpOiBSZWFjdC5FbGVtZW50PCo+IHtcbiAgICByZXR1cm4gKFxuICAgICAgPGRpdiBzdHlsZT17SEVBREVSX1NUWUxFU30+XG4gICAgICAgIHt0aGlzLl9yZW5kZXJIZWFkZXJzKCl9XG4gICAgICA8L2Rpdj5cbiAgICApO1xuICB9XG59XG4iXX0=